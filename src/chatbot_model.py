#!/usr/bin/env python3
# -*- coding: utf-8 -*-
import json
import os
import re
import requests
from datetime import datetime, date
import calendar
from bs4 import BeautifulSoup
from transformers import AutoTokenizer, AutoModelForCausalLM
import torch
import torch.nn as nn
from tqdm import tqdm
import time
import os

# í™˜ê²½ë³€ìˆ˜ë¡œ ì„¤ì •
os.environ["CUDA_VISIBLE_DEVICES"] = "0"  # GPU 1ë²ˆë§Œ ì‚¬ìš©

class CompleteCampusKnowledgeBase:
    """ì™„ì „í•œ ìº í¼ìŠ¤ ì§€ì‹ ë² ì´ìŠ¤ (ì •ì  + ì‹¤ì‹œê°„)"""

    def __init__(self):
        self.setup_static_knowledge()
        self.cache = {}
        self.cache_timeout = 1800  # 30ë¶„ ìºì‹œ

    def setup_static_knowledge(self):
        """ì •ì  ì§€ì‹ (í•­ìƒ ì •í™•í•œ ê¸°ë³¸ ì •ë³´)"""
        self.static_knowledge = {
            "graduation": {
                "overview": {
                    "university": "ì¶©ë‚¨ëŒ€í•™êµ",
                    "legal_basis": "ì¶©ë‚¨ëŒ€í•™êµ í•™ì¹™ ì œ53ì¡°",
                    "standard_credits": 130,
                    "note": "í•™ë¬¸ì˜ íŠ¹ì„±ìƒ í•„ìš”í•œ ê²½ìš° í•™ê³¼ë³„ë¡œ ë”°ë¡œ ì •í•  ìˆ˜ ìˆìŒ",
                    "contact": "í•™ì‚¬ì§€ì›ê³¼ 042-821-5025",
                    "website": "ì¶©ë‚¨ëŒ€ í™ˆí˜ì´ì§€ > í•™ì‚¬ì •ë³´ > êµìœ¡ê³¼ì •"
                },

                "basic_structure": {
                    "course_categories": {
                        "êµì–‘ê³¼ëª©": {
                            "description": "ëŒ€í•™ ì¡¸ì—…ìê°€ ê°–ì¶”ì–´ì•¼ í•  ì§€ë„ì  ì¸ê²©ì„ ë„ì•¼í•¨ì— í•„ìš”í•œ ê³¼ëª©",
                            "minimum_credits": 36,
                            "types": ["ê³µí†µê¸°ì´ˆêµì–‘", "í•µì‹¬êµì–‘", "ì¼ë°˜êµì–‘", "ì „ë¬¸ê¸°ì´ˆêµì–‘", "íŠ¹ë³„êµì–‘"]
                        },
                        "ì „ê³µê³¼ëª©": {
                            "description": "ì „ë¬¸í•™ìˆ ì—°êµ¬ì— ì§ì ‘ í•„ìš”ë¡œ í•˜ëŠ” ê³¼ëª©",
                            "types": ["ì „ê³µê¸°ì´ˆ", "ì „ê³µí•µì‹¬", "ì „ê³µì‹¬í™”"],
                            "note": "ì „ê³µí•µì‹¬ê³¼ ì „ê³µì‹¬í™”ëŠ” ìƒí˜¸ ì¸ì • ê°€ëŠ¥"
                        },
                        "ì¼ë°˜ì„ íƒê³¼ëª©": {
                            "description": "êµ°ì‚¬í•™ê´€ë ¨, ë´‰ì‚¬ê´€ë ¨, í‰ìƒêµìœ¡ì‚¬ê´€ë ¨ êµê³¼ëª© ë“±"
                        }
                    },

                    "credit_distribution_by_type": {
                        "ë‹¨ìˆ˜ì „ê³µì": {
                            "total_credits": 130,
                            "êµì–‘": 36,
                            "ì „ê³µ": "54-90 (í•™ê³¼ë³„ ìƒì´)",
                            "ì¼ë°˜ì„ íƒ": "4-40 (í•™ê³¼ë³„ ìƒì´)"
                        },
                        "ë³µìˆ˜ì „ê³µì": {
                            "total_credits": 130,
                            "êµì–‘": 36,
                            "ì£¼ì „ê³µ": "45-55 (í•™ê³¼ë³„ ìƒì´)",
                            "ë³µìˆ˜ì „ê³µ": "36í•™ì  ì´ìƒ",
                            "ì¼ë°˜ì„ íƒ": "ë‚˜ë¨¸ì§€ í•™ì "
                        },
                        "ë¶€ì „ê³µì": {
                            "total_credits": 130,
                            "êµì–‘": 36,
                            "ì „ê³µ": 54,
                            "ë¶€ì „ê³µ": "21í•™ì  ì´ìƒ",
                            "ì¼ë°˜ì„ íƒ": 40
                        }
                    }
                },

                "liberal_arts_detailed": {
                    "total_credits": 36,
                    "completion_period": "1~2í•™ë…„ ì¤‘ì‹¬",
                    "maximum_recognition": "42í•™ì ê¹Œì§€ë§Œ ì¸ì • (ì´ˆê³¼ ì‹œ ì¡¸ì—…í•™ì  ë¶ˆì¸ì •)",

                    "mandatory_courses": {
                        "ê³µí†µê¸°ì´ˆêµì–‘": {
                            "credits": 8,
                            "courses": {
                                "ê¸°ì´ˆê¸€ì“°ê¸°": "2í•™ì  (í•„ìˆ˜)",
                                "ëŒ€í•™ì˜ì–´1": "2í•™ì ",
                                "ëŒ€í•™ì˜ì–´2": "2í•™ì ",
                                "ëŒ€í•™ìƒí™œê³¼ì§„ë¡œì„¤ê³„": "1í•™ì  (í•„ìˆ˜)",
                                "ì·¨ì—…ê³¼ì°½ì—…": "1í•™ì  (í•„ìˆ˜)"
                            }
                        },

                        "í•µì‹¬êµì–‘": {
                            "credits": 9,
                            "requirement": "6ê°œ ì—­ëŸ‰ ì¤‘ ìµœì†Œ 3ê°œ ì—­ëŸ‰ì—ì„œ ê° 1ê³¼ëª©ì”©",
                            "competencies": {
                                "ì°½ì˜ìœµí•©": ["ê³µí•™ì…ë¬¸", "ì§€ì‹ì‚¬íšŒì™€ì •ë³´í™œìš©", "ë¹…ë°ì´í„°ì˜ì´í•´ì™€í™œìš©"],
                                "ê¸€ë¡œë²Œ": ["ê³µí•™ë„ë¥¼ìœ„í•œì„¸ê³„ë¬¸í™”", "í˜„ëŒ€ì¸ì˜ìƒí™œë¬¸í™”", "ì„œì–‘ì˜ì—­ì‚¬ì™€ë¬¸í™”"],
                                "ì˜ì‚¬ì†Œí†µ": ["ê³µí•™ë…¼ë¬¸ì‘ì„±ê³¼ë°œí‘œ", "ê²½ì œì˜ì´í•´", "ë…¼ë¦¬ì™€ë¹„íŒì ì‚¬ê³ "],
                                "ìê¸°ê´€ë¦¬": ["ê³µí•™ìœ¤ë¦¬", "ì»´í“¨í„°ì´í•´ì™€í™œìš©", "ì‹¬ë¦¬í•™ê°œë¡ "],
                                "ì¸ì„±": ["ì •ì‹ ê±´ê°•", "í•œë¬¸ê³ ì „ê³¼ì‚¶ì˜ì§€í˜œ", "í˜„ëŒ€ì¸ì˜ê²½ì œí™œë™ê³¼ë²•ë¥ "],
                                "ëŒ€ì¸ê´€ê³„": ["ì‚¬ì´ë²„ê³µê°„ê³¼ìœ¤ë¦¬", "ì—­ì‚¬ì™€ë¦¬ë”ì‹­", "ì¸ê°„ê´€ê³„ë¡ "]
                            }
                        },

                        "ì „ë¬¸ê¸°ì´ˆêµì–‘": {
                            "credits": "í•™ê³¼ë³„ ì§€ì •",
                            "common_courses": ["ë¯¸ì ë¶„í•™1", "ë¬¼ë¦¬í•™ê°œë¡ ", "ìƒë¬¼í•™", "ì»´í“¨í„°ê³¼í•™ì ì‚¬ê³ "]
                        },

                        "ì¼ë°˜êµì–‘": {
                            "credits": "ë‚˜ë¨¸ì§€ í•™ì ",
                            "areas": ["ì–¸ì–´Â·ë¬¸í•™", "ì—­ì‚¬Â·ì² í•™", "ì‚¬íšŒê³¼í•™", "ìì—°ê³¼í•™", "ì˜ˆìˆ Â·ì²´ìœ¡", "ìœµë³µí•©"]
                        }
                    },

                    "special_requirements": {
                        "ì¸ë¬¸í•™ê´€ë ¨": {
                            "requirement": "8í•™ì  ì´ìƒ ì´ìˆ˜",
                            "note": "ê¸°ì´ˆê¸€ì“°ê¸° 2í•™ì  í¬í•¨"
                        },
                        "ì†Œí”„íŠ¸ì›¨ì–´ê´€ë ¨": {
                            "applicable_from": "2022í•™ë…„ë„ ì´í›„ ì…í•™ì",
                            "requirement": "1ê³¼ëª© í•„ìˆ˜ ì´ìˆ˜",
                            "courses": [
                                "ì»´í“¨í„°ê³¼í•™ì ì‚¬ê³ ", "ì»´í“¨í„°ì´í•´ì™€í™œìš©", "ì •ë³´ë³´í˜¸ì…ë¬¸ê³¼í™œìš©",
                                "íŒŒì´ì¬í”„ë¡œê·¸ë˜ë°", "ë°ì´í„°ë¶„ì„ì…ë¬¸ê³¼í™œìš©", "í”„ë¡œê·¸ë˜ë°ì–¸ì–´",
                                "ì¸ê³µì§€ëŠ¥ê°œë¡ ", "ì¸ê³µì§€ëŠ¥ê³¼ë¯¸ë˜ì‚¬íšŒ", "ì¸ê³µì§€ëŠ¥ìœµí•©ê¸°ì´ˆ",
                                "ì›¹í”„ë¡œê·¸ë˜ë°ê¸°ì´ˆ", "Cí”„ë¡œê·¸ë˜ë°ê¸°ì´ˆ", "ê°€ìƒí˜„ì‹¤ì´í•´ì™€í™œìš©"
                            ]
                        }
                    }
                },

                "english_requirements": {
                    "ìˆ˜ëŠ¥ë“±ê¸‰ë³„_ì´ìˆ˜": {
                        "1ë“±ê¸‰": {
                            "ìˆ˜ê°•ê³¼ëª©": "ëŒ€í•™ì˜ì–´2ë§Œ",
                            "ì¶”ê°€ì´ìˆ˜": "í•µì‹¬êµì–‘ ë˜ëŠ” ì¼ë°˜êµì–‘ ì¤‘ 2í•™ì "
                        },
                        "2~9ë“±ê¸‰": {
                            "ìˆ˜ê°•ê³¼ëª©": "ëŒ€í•™ì˜ì–´1, 2 ìˆœì°¨ ì´ìˆ˜"
                        }
                    },
                    "ê³µì¸ì˜ì–´ì‹œí—˜_ë©´ì œê¸°ì¤€": {
                        "TOEIC": "800ì  ì´ìƒ",
                        "TOEFL_IBT": "91ì  ì´ìƒ",
                        "NEW_TEPS": "309ì  ì´ìƒ",
                        "TOEIC_Speaking": "130ì  ì´ìƒ",
                        "OPIc": "IM3 ì´ìƒ",
                        "IELTS": "7ì  ì´ìƒ"
                    },
                    "íŠ¹ë³„ì¡°ì¹˜": {
                        "ì™¸êµ­ì¸ì „í˜•ì…í•™ìƒ": "ëŒ€í•™ì˜ì–´ ìˆ˜ê°• ë¶ˆê°€, í•œêµ­ì–´1,2 í•„ìˆ˜",
                        "ì²­ê°ì¥ì• í•™ìƒ": "ëŒ€í•™ì˜ì–´1,2 ì´ìˆ˜ ë©´ì œ"
                    }
                },

                "major_requirements_by_department": {
                    "ì»´í“¨í„°ìœµí•©í•™ë¶€": {
                        "total_credits": 130,
                        "ë‹¨ìˆ˜ì „ê³µ": {
                            "êµì–‘": 36,
                            "ì „ê³µê¸°ì´ˆ": 18,
                            "ì „ê³µí•µì‹¬": 26,
                            "ì „ê³µì‹¬í™”": 46,
                            "ì¼ë°˜ì„ íƒ": 4
                        },
                        "ë³µìˆ˜ì „ê³µ": {
                            "êµì–‘": 36,
                            "ì „ê³µ": 54,
                            "ì¼ë°˜ì„ íƒ": 40
                        },
                        "required_courses": {
                            "ì „ê³µê¸°ì´ˆ": [
                                "ì»´í“¨í„°í”„ë¡œê·¸ë˜ë°1", "ì»´í“¨í„°í”„ë¡œê·¸ë˜ë°2", "í™•ë¥ ë°í†µê³„",
                                "ìë£Œêµ¬ì¡°", "ì»´í“¨í„°êµ¬ì¡°", "ì•Œê³ ë¦¬ì¦˜"
                            ]
                        },
                        "special_requirements": {
                            "track_completion": "9ê°œ íŠ¸ë™ ì¤‘ 1ê°œ ì´ìƒ",
                            "project_courses": "3ê°œ êµê³¼ëª© ì´ìƒ ì´ìˆ˜",
                            "portfolio": "í•„ìˆ˜",
                            "graduation_thesis": "í•„ìˆ˜"
                        },
                        "tracks": [
                            "ì¸ê³µì§€ëŠ¥", "ë¹…ë°ì´í„°", "ì›¹/ëª¨ë°”ì¼ê°œë°œì", "ì»´í“¨í„°ì‹œìŠ¤í…œ",
                            "ì‚¬ì´ë²„ë³´ì•ˆ", "ë°ì´í„°ì•„í‚¤í…íŠ¸", "ì»´í“¨í„°í•˜ë“œì›¨ì–´", "í´ë¼ìš°ë“œ/ì¸í”„ë¼", "ìê¸°ì„¤ê³„"
                        ]
                    },

                    "ì¸ê³µì§€ëŠ¥í•™ê³¼": {
                        "total_credits": 130,
                        "ë‹¨ìˆ˜ì „ê³µ": {
                            "êµì–‘": 36,
                            "ì „ê³µê¸°ì´ˆ": 15,
                            "ì „ê³µí•µì‹¬": 24,
                            "ì „ê³µì‹¬í™”": 39,
                            "ì¼ë°˜ì„ íƒ": 16
                        },
                        "required_courses": {
                            "ì „ê³µê¸°ì´ˆ": [
                                "ì´ì‚°ìˆ˜í•™", "ìë£Œêµ¬ì¡°", "AIí™œìš©í‘œí˜„ê³¼ë¬¸ì œí•´ê²°",
                                "ê¸°ê³„í•™ìŠµ", "ì»´í“¨í„°í”„ë¡œê·¸ë˜ë°1", "ì•Œê³ ë¦¬ì¦˜"
                            ]
                        }
                    },

                    "ì¼ë°˜_í•™ê³¼": {
                        "ì¸ë¬¸ëŒ€í•™": {
                            "total_credits": 130,
                            "êµì–‘": 36,
                            "ì „ê³µ": 78,
                            "ì¼ë°˜ì„ íƒ": 16
                        },
                        "ìì—°ê³¼í•™ëŒ€í•™": {
                            "total_credits": 130,
                            "êµì–‘": 36,
                            "ì „ê³µ": 81,
                            "ì¼ë°˜ì„ íƒ": 13
                        },
                        "ê³µê³¼ëŒ€í•™": {
                            "total_credits": 130,
                            "êµì–‘": 36,
                            "ì „ê³µ": 90,
                            "ì¼ë°˜ì„ íƒ": 4
                        }
                    }
                },

                "grade_requirements": {
                    "ì¼ë°˜í•™ìƒ": "ì „ì²´ êµê³¼ëª© ì„±ì ì˜ í‰ì í‰ê·  1.75 ì´ìƒ",
                    "ëŒ€í•™ì›ì—°ê³„ê³¼ì •": "ì „ì²´ êµê³¼ëª© ì„±ì ì˜ í‰ì í‰ê·  3.75 ì´ìƒ",
                    "ì¡°ê¸°ì¡¸ì—…": "ì „ì²´ êµê³¼ëª© ì„±ì ì˜ í‰ì í‰ê·  4.0 ì´ìƒ"
                },

                "additional_requirements": {
                    "future_design_counseling": {
                        "ì¼ë°˜í•™ìƒ": "5íšŒ ì´ìƒ í•„ìˆ˜",
                        "í¸ì…ìƒ": "2íšŒ ì´ìƒ",
                        "ì˜ì˜ˆê³¼_ìˆ˜ì˜ì˜ˆê³¼": "2íšŒ ì´ìƒ",
                        "ì¬ì…í•™ìƒ": {
                            "1í•™ë…„": "5íšŒ ì´ìƒ",
                            "2í•™ë…„": "4íšŒ ì´ìƒ",
                            "3í•™ë…„": "3íšŒ ì´ìƒ",
                            "4í•™ë…„_ì´ìƒ": "1íšŒ ì´ìƒ"
                        }
                    },

                    "special_programs": {
                        "êµì§ê³¼ì •": {
                            "ë‹¨ìˆ˜ì „ê³µ": "140í•™ì ",
                            "ë³µìˆ˜ì „ê³µ": "150í•™ì ",
                            "note": "êµì§ê³¼ëª© ë³„ë„ ì´ìˆ˜"
                        },
                        "í‰ìƒêµìœ¡ì‚¬ê³¼ì •": "ê´€ë ¨ ê³¼ëª© ì¶”ê°€ ì´ìˆ˜",
                        "ë§ˆì´í¬ë¡œë””ê·¸ë¦¬ê³¼ì •": "íŠ¹ì • ë¶„ì•¼ ì§‘ì¤‘ ì´ìˆ˜"
                    }
                },

                "special_cases": {
                    "ì˜ê³¼ëŒ€í•™": {
                        "ì˜ì˜ˆê³¼": "72í•™ì  (ìˆ˜ë£Œí•™ì )",
                        "ì˜í•™ê³¼": "164í•™ì ",
                        "note": "ë³µìˆ˜ì „ê³µ ì œí•œ"
                    },
                    "ìˆ˜ì˜ê³¼ëŒ€í•™": {
                        "ìˆ˜ì˜ì˜ˆê³¼": "72í•™ì  (ìˆ˜ë£Œí•™ì )",
                        "ìˆ˜ì˜í•™ê³¼": "160í•™ì ",
                        "note": "ë³µìˆ˜ì „ê³µ ì œí•œ"
                    },
                    "ì•½í•™ëŒ€í•™": {
                        "ì•½í•™ê³¼": "232í•™ì ",
                        "note": "ë³µìˆ˜ì „ê³µ ì œí•œ"
                    },
                    "ê±´ì¶•í•™ê³¼": {
                        "total_credits": 166,
                        "note": "ê±´ì¶•í•™êµìœ¡í”„ë¡œê·¸ë¨ì¸ì¦ ê¸°ì¤€"
                    }
                },

                "important_notes": [
                    "êµì–‘ê³¼ëª©ì€ 42í•™ì ê¹Œì§€ë§Œ ì¸ì •í•˜ë©° ì´ˆê³¼ ì‹œ ì¡¸ì—…í•™ì ìœ¼ë¡œ ì¸ì •í•˜ì§€ ì•ŠìŒ",
                    "ì „ê³µí•µì‹¬ê³¼ ì „ê³µì‹¬í™”ëŠ” ìƒí˜¸ ì¸ì •ë˜ì–´ êµ¬ë¶„ì—†ì´ ì´ìˆ˜ ê°€ëŠ¥",
                    "ì „ê³µê¸°ì´ˆëŠ” ìƒí˜¸ ì¸ì •ë˜ì§€ ì•Šì•„ í•„íˆ ìµœì†Œí•™ì  ì´ìƒ ì´ìˆ˜",
                    "ì´ìˆ˜ë©´ì œë¡œ ë¶€ì¡±í•œ í•™ì ì€ ì¼ë°˜, í•µì‹¬êµì–‘ì—ì„œ ì¶”ê°€ ì´ìˆ˜",
                    "ë³µìˆ˜ì „ê³µìëŠ” ë³µìˆ˜ì „ê³µ í•™ê³¼ì˜ ì „ê³µê³¼ëª©ì„ ì¶”ê°€ë¡œ ì´ìˆ˜",
                    "ë¶€ì „ê³µìëŠ” ë¶€ì „ê³µ í•™ê³¼ì˜ ì „ê³µê³¼ëª© 21í•™ì  ì´ìƒ ì´ìˆ˜",
                    "í•™ê³¼ë³„ ì„¸ë¶€ ìš”ê±´ì€ ì†Œì† í•™ê³¼ì—ì„œ ë³„ë„ í™•ì¸ í•„ìš”"
                ],

                "contact_information": {
                    "í•™ì‚¬ì§€ì›ê³¼": {
                        "phone": "042-821-5025",
                        "services": ["ì¡¸ì—…ìš”ê±´ ìƒë‹´", "í•™ì  ê´€ë¦¬", "ì„±ì  ê´€ë¦¬"]
                    },
                    "ê°_í•™ê³¼_ì‚¬ë¬´ì‹¤": {
                        "services": ["í•™ê³¼ë³„ ì„¸ë¶€ ìš”ê±´", "ì „ê³µ ê´€ë ¨ ìƒë‹´", "íŠ¸ë™ ì´ìˆ˜ ìƒë‹´"]
                    },
                    "í•™ìƒì§€ì›ê³¼": {
                        "phone": "042-821-5015",
                        "services": ["ì¥í•™ê¸ˆ", "ë“±ë¡ê¸ˆ", "ë³µìˆ˜ì „ê³µ ì‹ ì²­"]
                    }
                },

                "useful_tips": [
                    "ì¡¸ì—…ìš”ê±´ì€ ì…í•™ë…„ë„ ê¸°ì¤€ìœ¼ë¡œ ì ìš©ë©ë‹ˆë‹¤",
                    "ì „ê³µ ë³€ê²½ ì‹œ ë³€ê²½ëœ í•™ê³¼ ê¸°ì¤€ìœ¼ë¡œ ì ìš©ë©ë‹ˆë‹¤",
                    "ë¯¸ë¦¬ í•™ì  ê³„íšì„ ì„¸ì›Œ ë¶€ì¡±í•œ ì˜ì—­ì„ íŒŒì•…í•˜ì„¸ìš”",
                    "êµì–‘ê³¼ëª© 42í•™ì  ì œí•œì— ì£¼ì˜í•˜ì„¸ìš”",
                    "íŠ¸ë™ ì´ìˆ˜ë‚˜ ë³µìˆ˜ì „ê³µ ê³„íšì´ ìˆë‹¤ë©´ ë¯¸ë¦¬ ìƒë‹´ë°›ìœ¼ì„¸ìš”",
                    "ì¡¸ì—…ë…¼ë¬¸ì´ë‚˜ í¬íŠ¸í´ë¦¬ì˜¤ ìš”êµ¬ì‚¬í•­ì„ ë¯¸ë¦¬ í™•ì¸í•˜ì„¸ìš”"
                ]
            },

            "academic_schedule": {
                "overview": {
                    "academic_year": "2025í•™ë…„ë„",
                    "semester_system": "2í•™ê¸°ì œ (1í•™ê¸°: 3ì›”~6ì›”, 2í•™ê¸°: 9ì›”~12ì›”)",
                    "total_weeks": "ê° í•™ê¸° 15ì£¼ ìˆ˜ì—… + ì‹œí—˜ê¸°ê°„",
                    "contact": "í•™ì‚¬ì§€ì›ê³¼ 042-821-5025",
                    "website": "ì¶©ë‚¨ëŒ€ í™ˆí˜ì´ì§€(www.cnu.ac.kr) > í•™ì‚¬ì •ë³´",
                    "portal": "CNU í¬í„¸ì‹œìŠ¤í…œ(portal.cnu.ac.kr)"
                },

                "first_semester": {
                    "name": "2025í•™ë…„ë„ ì œ1í•™ê¸°",
                    "period": "2025ë…„ 3ì›” 4ì¼(í™”) ~ 2025ë…„ 6ì›” 23ì¼(ì›”)",

                    "registration": {
                        "pre_registration": {
                            "period": "2025ë…„ 1ì›” 31ì¼(ê¸ˆ) ~ 2ì›” 3ì¼(ì›”)",
                            "target": "ì¬í•™ìƒ ëŒ€ìƒ ì˜ˆë¹„ìˆ˜ê°•ì‹ ì²­",
                            "system": "CNU í¬í„¸ì‹œìŠ¤í…œ",
                            "notes": "ì‹¤ì œ ìˆ˜ê°•ì‹ ì²­ ì „ ë¯¸ë¦¬ ì‹ ì²­í•´ë³´ëŠ” ê¸°ê°„"
                        },
                        "main_registration": {
                            "period": "2025ë…„ 2ì›” 5ì¼(ìˆ˜) ~ 2ì›” 11ì¼(í™”)",
                            "time": "í•™ë…„ë³„ ì§€ì • ì‹œê°„ëŒ€",
                            "system": "CNU í¬í„¸ì‹œìŠ¤í…œ(portal.cnu.ac.kr)",
                            "priority": "ì¡¸ì—…ì˜ˆì •ì > ê³ í•™ë…„ > ì €í•™ë…„ ìˆœ",
                            "notes": "ì‹œê°„í‘œ ì¶©ëŒ ë° ìˆ˜ê°•ì¸ì› ì œí•œ í™•ì¸ í•„ìš”"
                        },
                        "confirmation_change": {
                            "period": "2025ë…„ 3ì›” 4ì¼(í™”) ~ 3ì›” 10ì¼(ì›”)",
                            "description": "ê°œê°• í›„ ìˆ˜ê°•ì‹ ì²­ í™•ì¸ ë° ë³€ê²½ ê¸°ê°„",
                            "notes": "ì‹¤ì œ ìˆ˜ì—… ì°¸ì—¬ í›„ ë³€ê²½ ê°€ëŠ¥"
                        },
                        "cancellation": {
                            "period": "2025ë…„ 3ì›” 24ì¼(ì›”) ~ 3ì›” 27ì¼(ëª©)",
                            "description": "ìˆ˜ê°•ì‹ ì²­ ì·¨ì†Œ ê¸°ê°„",
                            "effect": "ì„±ì í‘œì— ê¸°ë¡ë˜ì§€ ì•ŠìŒ",
                            "deadline": "3ì›” 27ì¼ 18:00ê¹Œì§€"
                        }
                    },

                    "tuition": {
                        "payment_period": "2025ë…„ 2ì›” 25ì¼(í™”) ~ 2ì›” 28ì¼(ê¸ˆ)",
                        "target": "ì¬í•™ìƒ ë“±ë¡ê¸ˆ ë‚©ë¶€",
                        "method": "ì€í–‰ ë°©ë¬¸, ì¸í„°ë„·ë±…í‚¹, ê°€ìƒê³„ì¢Œ",
                        "late_fee": "ë‚©ë¶€ ì§€ì—° ì‹œ ì—°ì²´ë£Œ ë¶€ê³¼",
                        "contact": "í•™ìƒì§€ì›ê³¼ 042-821-5015"
                    },

                    "semester_dates": {
                        "start_date": "2025ë…„ 3ì›” 4ì¼(í™”)",
                        "classes_start": "3ì›” 4ì¼ë¶€í„° ì •ê·œ ìˆ˜ì—… ì‹œì‘",
                        "quarter_point": "3ì›” 28ì¼ (ìˆ˜ì—…ì¼ìˆ˜ 1/4ì„ )",
                        "third_point": "4ì›” 7ì¼ (ìˆ˜ì—…ì¼ìˆ˜ 1/3ì„ )",
                        "half_point": "4ì›” 24ì¼ (ìˆ˜ì—…ì¼ìˆ˜ 1/2ì„ )",
                        "two_thirds_point": "5ì›” 15ì¼ (ìˆ˜ì—…ì¼ìˆ˜ 2/3ì„ )",
                        "three_quarters_point": "5ì›” 26ì¼ (ìˆ˜ì—…ì¼ìˆ˜ 3/4ì„ )",
                        "last_class": "6ì›” 23ì¼ ì •ê·œìˆ˜ì—… ì¢…ë£Œ"
                    },

                    "exam_periods": {
                        "midterm": {
                            "period": "2025ë…„ 4ì›” ì¤‘ìˆœ (ì •í™•í•œ ë‚ ì§œëŠ” í•™ê³¼ë³„ ê³µì§€)",
                            "duration": "ë³´í†µ 1ì£¼ì¼",
                            "notes": "ì¤‘ê°„ê³ ì‚¬ ê¸°ê°„ ì¤‘ ì •ê·œìˆ˜ì—… ì—†ìŒ"
                        },
                        "final": {
                            "period": "2025ë…„ 6ì›” ì¤‘ìˆœ (ì •í™•í•œ ë‚ ì§œëŠ” í•™ê³¼ë³„ ê³µì§€)",
                            "duration": "ë³´í†µ 1ì£¼ì¼",
                            "notes": "ê¸°ë§ê³ ì‚¬ í›„ í•™ê¸° ì¢…ë£Œ"
                        }
                    },

                    "grade_announcement": {
                        "date": "2025ë…„ 7ì›” 11ì¼(ê¸ˆ)",
                        "method": "CNU í¬í„¸ì‹œìŠ¤í…œì—ì„œ í™•ì¸",
                        "objection_period": "ì„±ì  ì´ì˜ì‹ ì²­ ê¸°ê°„ ë³„ë„ ê³µì§€",
                        "contact": "í•™ì‚¬ì§€ì›ê³¼ 042-821-5025"
                    },

                    "vacation": {
                        "start_date": "2025ë…„ 6ì›” 24ì¼(í™”)",
                        "name": "í•˜ê¸°ë°©í•™ (ì—¬ë¦„ë°©í•™)",
                        "duration": "ì•½ 2ê°œì›”",
                        "summer_session": {
                            "period": "6ì›” 24ì¼ ~ 7ì›” 14ì¼",
                            "registration": "5ì›” 8ì¼ ~ 5ì›” 12ì¼",
                            "description": "í•˜ê¸° ê³„ì ˆí•™ê¸° ìš´ì˜"
                        }
                    }
                },

                "second_semester": {
                    "name": "2025í•™ë…„ë„ ì œ2í•™ê¸°",
                    "period": "2025ë…„ 9ì›” 1ì¼(ì›”) ~ 2025ë…„ 12ì›” 21ì¼(ì¼)",

                    "registration": {
                        "pre_registration": {
                            "period": "2025ë…„ 7ì›” 28ì¼(ì›”) ~ 7ì›” 30ì¼(ìˆ˜)",
                            "target": "ì¬í•™ìƒ ëŒ€ìƒ ì˜ˆë¹„ìˆ˜ê°•ì‹ ì²­",
                            "system": "CNU í¬í„¸ì‹œìŠ¤í…œ"
                        },
                        "main_registration": {
                            "period": "2025ë…„ 8ì›” 4ì¼(ì›”) ~ 8ì›” 8ì¼(ê¸ˆ)",
                            "time": "í•™ë…„ë³„ ì§€ì • ì‹œê°„ëŒ€",
                            "system": "CNU í¬í„¸ì‹œìŠ¤í…œ(portal.cnu.ac.kr)"
                        },
                        "confirmation_change": {
                            "period": "2025ë…„ 9ì›” 1ì¼(ì›”) ~ 9ì›” 5ì¼(ê¸ˆ)",
                            "description": "ê°œê°• í›„ ìˆ˜ê°•ì‹ ì²­ í™•ì¸ ë° ë³€ê²½ ê¸°ê°„"
                        },
                        "cancellation": {
                            "period": "2025ë…„ 9ì›” 22ì¼(ì›”) ~ 9ì›” 25ì¼(ëª©)",
                            "description": "ìˆ˜ê°•ì‹ ì²­ ì·¨ì†Œ ê¸°ê°„",
                            "deadline": "9ì›” 25ì¼ 18:00ê¹Œì§€"
                        }
                    },

                    "tuition": {
                        "payment_period": "2025ë…„ 8ì›” 26ì¼(í™”) ~ 8ì›” 29ì¼(ê¸ˆ)",
                        "target": "ì¬í•™ìƒ ë“±ë¡ê¸ˆ ë‚©ë¶€"
                    },

                    "semester_dates": {
                        "start_date": "2025ë…„ 9ì›” 1ì¼(ì›”)",
                        "quarter_point": "9ì›” 25ì¼ (ìˆ˜ì—…ì¼ìˆ˜ 1/4ì„ )",
                        "third_point": "10ì›” 10ì¼ (ìˆ˜ì—…ì¼ìˆ˜ 1/3ì„ )",
                        "half_point": "10ì›” 29ì¼ (ìˆ˜ì—…ì¼ìˆ˜ 1/2ì„ )",
                        "two_thirds_point": "11ì›” 14ì¼ (ìˆ˜ì—…ì¼ìˆ˜ 2/3ì„ )",
                        "three_quarters_point": "11ì›” 25ì¼ (ìˆ˜ì—…ì¼ìˆ˜ 3/4ì„ )",
                        "last_class": "12ì›” 21ì¼ ì •ê·œìˆ˜ì—… ì¢…ë£Œ"
                    },

                    "exam_periods": {
                        "midterm": {
                            "period": "2025ë…„ 10ì›” ì¤‘ìˆœ",
                            "duration": "ë³´í†µ 1ì£¼ì¼"
                        },
                        "final": {
                            "period": "2025ë…„ 12ì›” ì¤‘ìˆœ",
                            "duration": "ë³´í†µ 1ì£¼ì¼"
                        }
                    },

                    "vacation": {
                        "start_date": "2025ë…„ 12ì›” 22ì¼(ì¼)",
                        "name": "ë™ê¸°ë°©í•™ (ê²¨ìš¸ë°©í•™)",
                        "duration": "ì•½ 2ê°œì›”",
                        "winter_session": {
                            "period": "12ì›” 22ì¼ ~ 2026ë…„ 1ì›” 13ì¼",
                            "registration": "11ì›” 7ì¼ ~ 11ì›” 11ì¼",
                            "description": "ë™ê¸° ê³„ì ˆí•™ê¸° ìš´ì˜"
                        }
                    }
                },

                "special_applications": {
                    "leave_return": {
                        "first_semester": "2025ë…„ 2ì›” 3ì¼ ~ 2ì›” 28ì¼",
                        "second_semester": "2025ë…„ 8ì›” 1ì¼ ~ 8ì›” 29ì¼",
                        "description": "íœ´í•™ ë° ë³µí•™ ì‹ ì²­",
                        "contact": "í•™ì‚¬ì§€ì›ê³¼ 042-821-5025"
                    },

                    "early_graduation": {
                        "first_semester": "2025ë…„ 3ì›” 31ì¼ ~ 4ì›” 4ì¼",
                        "second_semester": "2025ë…„ 9ì›” 25ì¼ ~ 10ì›” 2ì¼",
                        "description": "ì¡°ê¸°ì¡¸ì—… ì‹ ì²­",
                        "requirements": "í‰ì í‰ê·  3.75 ì´ìƒ, ì†Œì • í•™ì  ì´ìˆ˜"
                    },

                    "thesis_deferral": {
                        "periods": [
                            "2025ë…„ 1ì›” 20ì¼ ~ 1ì›” 24ì¼",
                            "2025ë…„ 3ì›” 4ì¼ ~ 3ì›” 11ì¼ (ì·¨ì†Œ)",
                            "2025ë…„ 7ì›” 21ì¼ ~ 7ì›” 25ì¼",
                            "2025ë…„ 9ì›” 1ì¼ ~ 9ì›” 8ì¼ (ì·¨ì†Œ)"
                        ],
                        "description": "í•™ì‚¬í•™ìœ„ì·¨ë“ ìœ ì˜ˆ ì‹ ì²­ ë° ì·¨ì†Œ"
                    },

                    "convergence_major": {
                        "first_semester": "2025ë…„ 4ì›” 7ì¼ ~ 4ì›” 11ì¼",
                        "second_semester": "2025ë…„ 10ì›” 13ì¼ ~ 10ì›” 17ì¼",
                        "description": "ìœµë³µí•©ì°½ì˜ì „ê³µ ì‹ ì²­ ë° ì·¨ì†Œ"
                    },

                    "curriculum_change": {
                        "first_semester": "2025ë…„ 3ì›” 4ì¼ ~ 3ì›” 31ì¼",
                        "second_semester": "2025ë…„ 9ì›” 1ì¼ ~ 9ì›” 30ì¼",
                        "description": "êµìœ¡ê³¼ì • ì ìš©ì—°ë„ ë° ì†Œì† ë³€ê²½"
                    }
                },

                "ceremonies_events": {
                    "entrance_ceremony": {
                        "date": "2025ë…„ 2ì›” 28ì¼(ê¸ˆ)",
                        "description": "2025í•™ë…„ë„ ì…í•™ì‹",
                        "location": "ì¶©ë‚¨ëŒ€í•™êµ ëŒ€ê°•ë‹¹ (ì˜ˆì •)"
                    },

                    "graduation_ceremonies": {
                        "february": {
                            "date": "2025ë…„ 2ì›” 25ì¼(í™”)",
                            "description": "2024ë…„ë„ ì „ê¸° í•™ìœ„ìˆ˜ì—¬ì‹"
                        },
                        "august": {
                            "date": "2025ë…„ 8ì›” 25ì¼(ì›”)",
                            "description": "2024ë…„ë„ í›„ê¸° í•™ìœ„ìˆ˜ì—¬ì‹"
                        }
                    },

                    "founding_day": {
                        "date": "2025ë…„ 5ì›” 25ì¼(ì¼)",
                        "description": "ì¶©ë‚¨ëŒ€í•™êµ ê°œêµê¸°ë…ì¼",
                        "note": "ìˆ˜ì—… ë° ì…”í‹€ë²„ìŠ¤ ìš´í–‰ ì—†ìŒ"
                    }
                },

                "important_notes": [
                    "ëª¨ë“  ì¼ì •ì€ í•™êµ ì‚¬ì •ì— ë”°ë¼ ë³€ê²½ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤",
                    "ì •í™•í•œ ì‹œí—˜ ì¼ì •ì€ ê° í•™ê³¼ ë° ë‹´ë‹¹ êµìˆ˜ë‹˜ê»˜ í™•ì¸í•˜ì„¸ìš”",
                    "ìˆ˜ê°•ì‹ ì²­ì€ ì§€ì •ëœ ì‹œê°„ì—ë§Œ ê°€ëŠ¥í•˜ë©°, ì„œë²„ ê³¼ë¶€í•˜ì— ì£¼ì˜í•˜ì„¸ìš”",
                    "ë“±ë¡ê¸ˆ ë‚©ë¶€ ê¸°í•œì„ ë„˜ê¸°ë©´ ìë™ ì œì ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤",
                    "ê³µíœ´ì¼ì´ ê²¹ì¹˜ëŠ” ê²½ìš° ì¼ì •ì´ ì¡°ì •ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤",
                    "ê³„ì ˆí•™ê¸°ëŠ” ë³„ë„ ìˆ˜ê°•ë£Œê°€ ë¶€ê³¼ë©ë‹ˆë‹¤"
                ],

                "helpful_tips": [
                    "ìˆ˜ê°•ì‹ ì²­ ì „ ë¯¸ë¦¬ ì‹œê°„í‘œë¥¼ ê³„íší•´ë³´ì„¸ìš”",
                    "ì¸ê¸° ê³¼ëª©ì€ ìˆ˜ê°•ì‹ ì²­ ì‹œì‘ê³¼ ë™ì‹œì— ë§ˆê°ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤",
                    "ì¡¸ì—…ìš”ê±´ì„ ë¯¸ë¦¬ í™•ì¸í•˜ì—¬ í•„ìš”í•œ ê³¼ëª©ì„ íŒŒì•…í•˜ì„¸ìš”",
                    "ì„±ì  ì´ì˜ì‹ ì²­ì€ ì •í•´ì§„ ê¸°ê°„ ë‚´ì—ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤",
                    "íœ´í•™ ì‹œ ë³µí•™ ì‹œê¸°ë¥¼ ë¯¸ë¦¬ ê³„íší•˜ì„¸ìš”"
                ],

                "contact_info": {
                    "í•™ì‚¬ì§€ì›ê³¼": {
                        "phone": "042-821-5025",
                        "services": ["ì¡¸ì—…ìš”ê±´", "í•™ì‚¬ì¼ì •", "ìˆ˜ê°•ì‹ ì²­", "ì„±ì ê´€ë¦¬"]
                    },
                    "í•™ìƒì§€ì›ê³¼": {
                        "phone": "042-821-5015",
                        "services": ["ë“±ë¡ê¸ˆ", "ì¥í•™ê¸ˆ", "í•™ì ê´€ë¦¬"]
                    },
                    "ê°_í•™ê³¼_ì‚¬ë¬´ì‹¤": {
                        "services": ["ì „ê³µ ê´€ë ¨ ìƒë‹´", "ì‹œí—˜ ì¼ì •", "ì¡¸ì—…ë…¼ë¬¸"]
                    }
                },

                "online_systems": {
                    "cnu_portal": {
                        "url": "portal.cnu.ac.kr",
                        "services": ["ìˆ˜ê°•ì‹ ì²­", "ì„±ì ì¡°íšŒ", "í•™ì ì¡°íšŒ", "ì¦ëª…ì„œ ë°œê¸‰"]
                    },
                    "main_website": {
                        "url": "www.cnu.ac.kr",
                        "services": ["ê³µì§€ì‚¬í•­", "í•™ì‚¬ì¼ì •", "í•™êµì†Œì‹"]
                    }
                }
            },

            "dining": {
                "student_restaurant": {
                    "location": "ì œ 1í•™ìƒíšŒê´€",
                    "korean": "í•œì‹ í‰ê·  4,000ì›",
                    "western": "ì–‘ì‹ í‰ê·  5,000ì›",
                    "chinese": "ì¤‘ì‹ í‰ê·  5,500ì›",
                    "special": "íŠ¹ì‹ í‰ê·  6,000ì›"
                },
                "faculty_restaurant": {
                    "location": "ì œ 2í•™ìƒíšŒê´€",
                    "price": "4,500ì›"
                },
                "cafeteria": {
                    "location": "ì •ì‹¬í™”êµ­ì œë¬¸í™”íšŒê´€ 1ì¸µ",
                    "menu": "ì»¤í”¼, ê°„ì‹, ìƒëŸ¬ë“œ"
                },
                "hours": {
                    "breakfast": "08:00-09:30 (í‰ì¼, ì¼ë¶€ ì‹ë‹¹)",
                    "lunch": "11:30-14:00",
                    "dinner": "17:30-19:00"
                },
                "more_info":"ì‹ë‹¨í‘œ í™•ì¸ì€ 2ì¼ë’¤ê¹Œì§€ë§Œ ê³µê°œë©ë‹ˆë‹¤.",
                "weekend": "ì£¼ë§ì—ëŠ” ì‹ë‹¹ì´ ìš´ì˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.",
                "info_source": "ìƒí˜‘ í™ˆí˜ì´ì§€(coop.cnu.ac.kr)ì—ì„œ ì‹ë‹¨ì„ í™•ì¸í•˜ì„¸ìš”.",
                "contact": "ìƒí™œí˜‘ë™ì¡°í•©(042-821-5890)ìœ¼ë¡œ ë¬¸ì˜í•˜ì„¸ìš”."
            },

            "shuttle": {
                "operation_overview": {
                    "period": "2025. 3. 4.(í™”) ~ 2025. 12. 19.(ê¸ˆ), ì´ 150ì¼",
                    "location": "êµë‚´(ëŒ€ë•ìº í¼ìŠ¤) ë° ìº í¼ìŠ¤ ìˆœí™˜(ëŒ€ë•â†”ë³´ìš´)",
                    "buses": "í•™êµë²„ìŠ¤ ì´ 2ëŒ€, 41ì¸ìŠ¹",
                    "operation_days": "í•™ê¸° ì¤‘ ì£¼ê°„ ìš´ì˜(ì›”~ê¸ˆ)",
                    "non_operation": "ê³µíœ´ì¼Â·ëŒ€ì²´ê³µíœ´ì¼Â·ê°œêµê¸°ë…ì¼Â·ë°©í•™Â·ìˆ˜í•™ëŠ¥ë ¥ì‹œí—˜ì¼(10ì‹œ ì´ì „ê¹Œì§€) ë“± ë¯¸ìš´ì˜"
                },

                "campus_internal": {
                    "name": "êµë‚´ ìˆœí™˜ (ëŒ€ë•ìº í¼ìŠ¤ ë‚´)",
                    "operation_period": "í•™ê¸° ì¤‘ 3.4.ï½12.19. ì´ 150ì¼ (ì›”ï½ê¸ˆ)",
                    "buses": "1ëŒ€",
                    "frequency": "1ì¼ ì´ 10íšŒ ìš´ì˜",
                    "first_bus": "08:30",
                    "last_bus": "17:30",
                    "morning_special": "ë“±êµ 1íšŒì°¨: ì›”í‰ì—­ ì¶œë°œ 08:20 â†’ ì •ì‹¬í™” êµ­ì œë¬¸í™”íšŒê´€ ë„ì°©",
                    "schedule": [
                        "08:30", "09:30", "09:40", "10:30", "11:30",
                        "13:30", "14:30", "15:30", "16:30", "17:30"
                    ],

                    "route_stops": [
                        "ì •ì‹¬í™” êµ­ì œë¬¸í™”íšŒê´€", "ì‚¬íšŒê³¼í•™ëŒ€í•™ ì…êµ¬(í•œëˆ„ë¦¬íšŒê´€ ë’¤)",
                        "ì„œë¬¸(ê³µë™ì‹¤í—˜ì‹¤ìŠµê´€ ì•)", "ìŒì•… 2í˜¸ê´€ ì•", "ê³µë™ë™ë¬¼ì‹¤í—˜ì„¼í„°(íšŒì°¨)",
                        "ì²´ìœ¡ê´€ ì…êµ¬", "ì˜ˆìˆ ëŒ€í•™ ì•", "ë„ì„œê´€ ì•(ëŒ€í•™ë³¸ë¶€ ì˜†)", "í•™ìƒìƒí™œê´€ 3ê±°ë¦¬",
                        "ë†ì—…ìƒëª…ê³¼í•™ëŒ€í•™ ì•", "ë™ë¬¸ì£¼ì°¨ì¥"
                    ]
                },

                "campus_circulation": {
                    "name": "ìº í¼ìŠ¤ ìˆœí™˜ (ëŒ€ë•â†”ë³´ìš´)",
                    "operation_period": "í•™ê¸° ì¤‘ (ì›”ï½ê¸ˆ)",
                    "buses": "1ëŒ€",
                    "frequency": "1ì¼ ì´ 1íšŒ ìš´ì˜ (íšŒì°¨)",
                    "departure": "08:10 (ëŒ€ë• ê³¨í”„ì—°ìŠµì¥)",
                    "arrival": "08:50 (ë³´ìš´ìº í¼ìŠ¤)",
                    "route": "ê³¨í”„ì—°ìŠµì¥(08:10) â†’ ì¤‘ì•™ë„ì„œê´€(08:11) â†’ ì‚°í•™ì—°êµìœ¡ì—°êµ¬ê´€(08:12) â†’ ì¶©ë‚¨ëŒ€ì…êµ¬ ë²„ìŠ¤ì •ë¥˜ì¥(08:13) â†’ ì›”í‰ì—­(08:15) â†’ ë³´ìš´ìº í¼ìŠ¤(08:50)",
                    "return_route": "ë³´ìš´ìº í¼ìŠ¤ â†’ ë‹¤ì†”ì•„íŒŒíŠ¸ ê±´ë„ˆí¸ â†’ ì œ2í•™ìƒíšŒê´€ â†’ ì¤‘ì•™ë„ì„œê´€ â†’ ê³¨í”„ì—°ìŠµì¥"
                },

                "external_stops": {
                    "ì›”í‰ì—­": "3ë²ˆ ì¶œêµ¬ ê±´ë„ˆí¸(í…Œë‹ˆìŠ¤ì¥ ì• ë²„ìŠ¤ì •ë¥˜ì¥ ë¶€ê·¼)",
                    "ì¶©ë‚¨ëŒ€ì…êµ¬": "ë²„ìŠ¤ì •ë¥˜ì¥(í™ˆí”ŒëŸ¬ìŠ¤ìœ ì„±ì ë°©ë©´)",
                    "ë³´ìš´ìº í¼ìŠ¤": "íšŒì°¨ì§€ì ",
                    "ë‹¤ì†”ì•„íŒŒíŠ¸": "ê±´ë„ˆí¸"
                },

                "important_notes": [
                    "êµí†µìƒí™© ë“±ìœ¼ë¡œ ì¸í•´ ì „ êµ¬ê°„ì—ì„œ 5ë¶„ ë‚´ì™¸ ì˜¤ì°¨ ë°œìƒ ê°€ëŠ¥",
                    "íƒ‘ìŠ¹ìëŠ” ì‚¬ì „ ëŒ€ê¸° í•„ìš”",
                    "í•™êµ ë²„ìŠ¤ê°€ ë³´ì´ë©´ íƒ‘ìŠ¹ ì˜ì‚¬ë¥¼ ì•Œë ¤ì£¼ì„¸ìš”",
                    "ìš´í–‰ì‹œê°„ì€ ì²œì¬ì§€ë³€, í•™êµí–‰ì‚¬, êµí†µìƒí™©, íƒ‘ìŠ¹ ì¸ì› ë“±ì— ë”°ë¼ ë³€ê²½ ê°€ëŠ¥",
                    "ì„¸ë¶€ ìš´í–‰ì‹œê°„ì€ ì´ìš©ì ë° ìš´í–‰ ì¶”ì´ì— ë”°ë¼ ë…¼ì˜ë¥¼ ê±°ì³ ë³€ë™ ê°€ëŠ¥"
                ],

                "contact": "ì´ë¬´ê³¼(042-821-5114) ë˜ëŠ” í•™ìƒì²˜ í•™ìƒê³¼",
                "last_updated": "2025. 2. 18.(í™”), í•™ìƒì²˜ í•™ìƒê³¼"
            },

            "notice": {
                "main_website": "ì¶©ë‚¨ëŒ€ í™ˆí˜ì´ì§€(www.cnu.ac.kr)ì—ì„œ í™•ì¸í•˜ì„¸ìš”.",
                "portal": "CNU í¬í„¸ì‹œìŠ¤í…œì—ì„œë„ ì¤‘ìš” ê³µì§€ë¥¼ ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.",
                "department": "ê° í•™ê³¼ í™ˆí˜ì´ì§€ì—ì„œ í•™ê³¼ë³„ ê³µì§€ë¥¼ í™•ì¸í•˜ì„¸ìš”.",
                "scholarship": "ì¥í•™ê¸ˆ ê³µì§€ëŠ” í•™ìƒì§€ì›ê³¼ì—ì„œ ë‹´ë‹¹í•©ë‹ˆë‹¤.",
                "student_council": "ì´í•™ìƒíšŒ ê³µì§€ëŠ” ì´í•™ìƒíšŒ í™ˆí˜ì´ì§€ì—ì„œ í™•ì¸í•˜ì„¸ìš”.",
                "contacts": {
                    "í•™ì‚¬ì§€ì›ê³¼": "042-821-5025",
                    "í•™ìƒì§€ì›ê³¼": "042-821-5015"
                }
            },

            "contacts": {
                "í•™ì‚¬ì§€ì›ê³¼": "042-821-5025 (ì¡¸ì—…ìš”ê±´, í•™ì‚¬ì¼ì •)",
                "í•™ìƒì§€ì›ê³¼": "042-821-5015 (ì¥í•™ê¸ˆ, í•™ìƒí™œë™)",
                "ì´ë¬´ê³¼": "042-821-5114 (ì…”í‹€ë²„ìŠ¤, ì‹œì„¤)",
                "ìƒí™œí˜‘ë™ì¡°í•©": "042-821-5890 (ì‹ë‹¹, ë§¤ì )",
                "ë„ì„œê´€": "042-821-5092",
                "ì •ë³´í†µì‹ ì›": "042-821-6851"
            }
        }

    def extract_date_from_question(self, question):
        """ì§ˆë¬¸ì—ì„œ ë‚ ì§œ ì¶”ì¶œ"""
        import re
        from datetime import timedelta

        # ì–´ì œ
        if any(word in question.lower() for word in ['ì–´ì œ', 'yesterday']):
            yesterday = date.today() - timedelta(days=1)
            return yesterday.strftime("%Y.%m.%d")

        # ì˜¤ëŠ˜, ì§€ê¸ˆ
        if any(word in question.lower() for word in ['ì˜¤ëŠ˜', 'today', 'ì§€ê¸ˆ']):
            return None  # Noneì´ë©´ ì˜¤ëŠ˜ ë‚ ì§œ ì‚¬ìš©

        # ë‚´ì¼
        if any(word in question.lower() for word in ['ë‚´ì¼', 'tomorrow']):
            tomorrow = date.today() + timedelta(days=1)
            return tomorrow.strftime("%Y.%m.%d")

        # ëª¨ë ˆ
        if any(word in question.lower() for word in ['ëª¨ë ˆ']):
            day_after_tomorrow = date.today() + timedelta(days=2)
            return day_after_tomorrow.strftime("%Y.%m.%d")

        # ì´ë²ˆ ì£¼ ìš”ì¼ë“¤
        weekday_patterns = {
            'ì›”ìš”ì¼': 0, 'í™”ìš”ì¼': 1, 'ìˆ˜ìš”ì¼': 2, 'ëª©ìš”ì¼': 3,
            'ê¸ˆìš”ì¼': 4, 'í† ìš”ì¼': 5, 'ì¼ìš”ì¼': 6
        }

        for weekday_name, weekday_num in weekday_patterns.items():
            if weekday_name in question:
                today = date.today()
                days_ahead = weekday_num - today.weekday()

                # ì´ë²ˆ ì£¼ í•´ë‹¹ ìš”ì¼ì´ ì§€ë‚¬ìœ¼ë©´ ë‹¤ìŒ ì£¼
                if days_ahead <= 0:
                    days_ahead += 7

                target_date = today + timedelta(days=days_ahead)
                return target_date.strftime("%Y.%m.%d")

        # ìˆ«ì ë‚ ì§œ íŒ¨í„´ (2024.12.25, 2024-12-25, 12/25 ë“±)
        date_patterns = [
            r'(\d{4})[.\-/](\d{1,2})[.\-/](\d{1,2})',  # YYYY.MM.DD
            r'(\d{1,2})[.\-/](\d{1,2})',  # MM.DD (ì˜¬í•´)
        ]

        for pattern in date_patterns:
            match = re.search(pattern, question)
            if match:
                groups = match.groups()
                if len(groups) == 3:
                    year, month, day = groups
                    return f"{year}.{month.zfill(2)}.{day.zfill(2)}"
                elif len(groups) == 2:
                    month, day = groups
                    current_year = date.today().year
                    return f"{current_year}.{month.zfill(2)}.{day.zfill(2)}"

        # ë‚ ì§œë¥¼ ì°¾ì§€ ëª»í•˜ë©´ None (ì˜¤ëŠ˜ ë‚ ì§œ ì‚¬ìš©)
        return None

    def fetch_today_menu(self, date_str=None):
        """ì‹ë‹¨ í¬ë¡¤ë§ - ë‚ ì§œ ìë™ ì²˜ë¦¬"""

        # 1. ë‚ ì§œ ì²˜ë¦¬ ê°œì„ 
        if date_str is None:
            # ë‚ ì§œê°€ ì—†ìœ¼ë©´ ì˜¤ëŠ˜ ë‚ ì§œ ì‚¬ìš©
            print("date_strì •ë³´ì—†ìŒ")
            today = date.today()
            date_str = today.strftime("%Y.%m.%d")
        else:
            # ë‹¤ì–‘í•œ ë‚ ì§œ í˜•ì‹ ì²˜ë¦¬
            date_str = self.normalize_date_format(date_str)

        print(f"ğŸ½ï¸ {date_str} ì‹ë‹¨ í¬ë¡¤ë§ ì¤‘...")

        try:
            url = f"https://mobileadmin.cnu.ac.kr/food/index.jsp?searchYmd={date_str}&searchLang=OCL04.10&searchView=cafeteria&searchCafeteria=OCL03.02&Language_gb=OCL04.10"

            response = requests.get(url, timeout=10)
            response.raise_for_status()
            response.encoding = "utf-8"

            soup = BeautifulSoup(response.text, "html.parser")
            table = soup.find("table", class_="menu-tbl type-cap")

            if not table:
                print("âš ï¸ ì‹ë‹¨í‘œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")

            meals = []
            current_meal_type = None

            # ì‹ë‹¹ëª… ì¶”ì¶œ (ì œ2í•™ìƒíšŒê´€ë¶€í„°)
            headers = table.find("thead")
            if not headers:
                print("2í•™ x")

            header_cells = headers.find_all("th")[2:]  # êµ¬ë¶„, ì œ1í•™ìƒíšŒê´€ ì œì™¸
            cafeteria_names = [th.get_text(strip=True) for th in header_cells]

            # ë©”ë‰´ ë°ì´í„° ì¶”ì¶œ
            tbody = table.find("tbody")
            if not tbody:
                print("ë©”ë‰´x")

            rows = tbody.find_all("tr")

            for row in rows:
                cols = row.find_all("td")
                if not cols:
                    continue

                # rowspanì´ ìˆëŠ” ê²½ìš° (ìƒˆë¡œìš´ ì‹ì‚¬ íƒ€ì…)
                if len(cols) > 0 and 'rowspan' in cols[0].attrs:
                    current_meal_type = cols[0].get_text(strip=True)
                    if len(cols) > 1:
                        current_target = cols[1].get_text(strip=True)
                        menu_cols = cols[2:] if len(cols) > 2 else []
                    else:
                        current_target = "ì „ì²´"
                        menu_cols = []
                else:
                    # rowspanì´ ì—†ëŠ” ê²½ìš°
                    if len(cols) > 0:
                        current_target = cols[0].get_text(strip=True)
                        menu_cols = cols[1:] if len(cols) > 1 else []
                    else:
                        continue

                # ê° ì‹ë‹¹ë³„ ë©”ë‰´ ì²˜ë¦¬
                for idx, col in enumerate(menu_cols):
                    if idx >= len(cafeteria_names):
                        continue

                    cafeteria = cafeteria_names[idx]

                    # ë©”ë‰´ í…ìŠ¤íŠ¸ ì¶”ì¶œ
                    menu_html = col.find("p")
                    if menu_html:
                        menu_text = menu_html.get_text(separator="\n", strip=True)
                    else:
                        menu_text = col.get_text(strip=True)

                    # ìš´ì˜í•˜ì§€ ì•ŠëŠ” ê²½ìš° ì œì™¸
                    if any(skip_word in menu_text for skip_word in ["ìš´ì˜ì•ˆí•¨", "ë©”ë‰´ìš´ì˜ë‚´ì—­", "ì¤€ë¹„ì¤‘"]):
                        continue

                    if not menu_text.strip():
                        continue

                    # ë©”ë‰´ ë¼ì¸ ì •ë¦¬
                    menu_lines = [line.strip() for line in menu_text.strip().split("\n") if line.strip()]

                    if menu_lines:  # ë©”ë‰´ê°€ ìˆëŠ” ê²½ìš°ë§Œ ì¶”ê°€
                        meals.append({
                            "meal_type": current_meal_type or "ì •ë³´ì—†ìŒ",
                            "target": current_target or "ì „ì²´",
                            "cafeteria": cafeteria,
                            "menu": menu_lines
                        })

            result = {
                "status": "success",
                "date": date_str.replace(".", "-"),
                "meals": meals,
                "total_cafeterias": len(meals),
                "source": "ì¶©ë‚¨ëŒ€ ëª¨ë°”ì¼ ì‹ë‹¨í‘œ"
            }

            print(f"âœ… {len(meals)}ê°œ ì‹ë‹¹ ë©”ë‰´ ìˆ˜ì§‘ ì™„ë£Œ")
            return result

        except Exception as e:
            print(f"âŒ ì‹ë‹¨ í¬ë¡¤ë§ ì˜¤ë¥˜: {e}")

    def fetch_latest_notices(self):
        print("ğŸ“¢ ê³µì§€ì‚¬í•­ í¬ë¡¤ë§ ì¤‘...")

        try:
            # ê¸°ë³¸ URL
            BASE_URL = "https://plus.cnu.ac.kr/_prog/_board/"

            # ìš”ì²­ íŒŒë¼ë¯¸í„°
            PARAMS = {
                "code": "sub07_0702",
                "site_dvs_cd": "kr",
                "menu_dvs_cd": "0702",
                "skey": "",
                "sval": "",
                "site_dvs": "",
                "ntt_tag": "",
                "GotoPage": 1
            }

            def get_notice_list(page=1):
                PARAMS["GotoPage"] = page
                response = requests.get(BASE_URL, params=PARAMS)
                response.encoding = 'utf-8'
                soup = BeautifulSoup(response.text, 'html.parser')

                # board_list í´ë˜ìŠ¤ì˜ div ê°ì²´ ì°¾ê¸°
                board_div = soup.find('div', class_='board_list')
                if not board_div:
                    print("ğŸ“› 'board_list' í´ë˜ìŠ¤ë¥¼ ê°€ì§„ divë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.")
                    return []

                rows = board_div.find_all('tr')
                notices = []

                for row in rows[1:]:  # ì²« ë²ˆì§¸ëŠ” í—¤ë”
                    cols = row.find_all('td')
                    if len(cols) < 4:
                        continue

                    title_tag = cols[1].find('a')
                    if not title_tag:
                        continue

                    title = title_tag.get_text(strip=True)

                    # ì‘ì„±ì
                    writer = cols[2].get_text(strip=True)

                    # ë‚ ì§œ
                    date = cols[3].get_text(strip=True)

                    notices.append({
                        'title': title,
                        'writer': writer,
                        'date': date
                    })

                return notices

            all_notices = []
            for page in range(1, 6):  # ì˜ˆ: 5í˜ì´ì§€ê¹Œì§€ í¬ë¡¤ë§
                notices = get_notice_list(page)
                if not notices:
                    break
                all_notices.extend(notices)

            print(f"ì´ {len(all_notices)}ê°œì˜ ê²Œì‹œë¬¼ ìˆ˜ì§‘ ì™„ë£Œ")
            return all_notices

        except Exception as e:
            print(f"âŒ ê³µì§€ì‚¬í•­ í¬ë¡¤ë§ ì˜¤ë¥˜: {e}")
            return [{
                "title": "ê³µì§€ì‚¬í•­ì„ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.",
                "message": "ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•˜ê³  ì¶©ë‚¨ëŒ€ í™ˆí˜ì´ì§€ë¥¼ ì§ì ‘ ë°©ë¬¸í•˜ì„¸ìš”.",
                "url": self.urls["main_notice"]
            }]

    def normalize_date_format(self, date_input):
        """ë‹¤ì–‘í•œ ë‚ ì§œ í˜•ì‹ì„ YYYY.MM.DDë¡œ ë³€í™˜"""
        try:
            # ì´ë¯¸ ì˜¬ë°”ë¥¸ í˜•ì‹ì¸ ê²½ìš°
            if isinstance(date_input, str) and len(date_input) == 10 and "." in date_input:
                return date_input

            # date ê°ì²´ì¸ ê²½ìš°
            if isinstance(date_input, date):
                return date_input.strftime("%Y.%m.%d")

            # ë¬¸ìì—´ ì²˜ë¦¬
            if isinstance(date_input, str):
                # "-" êµ¬ë¶„ìë¥¼ "."ë¡œ ë³€ê²½
                if "-" in date_input:
                    return date_input.replace("-", ".")

                # ê¸°íƒ€ í˜•ì‹ ì²˜ë¦¬
                date_input = date_input.replace("/", ".").replace(" ", "")

                # YYYY.M.D í˜•ì‹ì„ YYYY.MM.DDë¡œ ë³€í™˜
                parts = date_input.split(".")
                if len(parts) == 3:
                    year, month, day = parts
                    return f"{year}.{month.zfill(2)}.{day.zfill(2)}"

            # íŒŒì‹± ì‹¤íŒ¨ ì‹œ ì˜¤ëŠ˜ ë‚ ì§œ
            return date.today().strftime("%Y.%m.%d")

        except Exception:
            return date.today().strftime("%Y.%m.%d")

    def search_comprehensive_info(self, question):
        """í¬ê´„ì ì¸ ì •ë³´ ê²€ìƒ‰ (ì •ì  + ì‹¤ì‹œê°„)"""
        question_lower = question.lower()
        relevant_info = []

        # ì¡¸ì—…ìš”ê±´ ê´€ë ¨
        if any(word in question_lower for word in ['ì¡¸ì—…', 'í•™ì ', 'ì „ê³µ', 'êµì–‘', 'ìš”ê±´', 'ë…¼ë¬¸']):
            relevant_info.append(("ì¡¸ì—…ìš”ê±´_ì •ë³´", self.static_knowledge["graduation"]))

        # ê³µì§€ì‚¬í•­ ê´€ë ¨ (ì‹¤ì‹œê°„ í¬ë¡¤ë§)
        if any(word in question_lower for word in ['ê³µì§€', 'ì¥í•™ê¸ˆ', 'ì‹ ì²­', 'ì•ˆë‚´', 'ì†Œì‹', 'í–‰ì‚¬']):
            latest_notices = self.fetch_latest_notices()
            relevant_info.append(("ìµœì‹ ê³µì§€", latest_notices))
            relevant_info.append(("ê³µì§€ì‚¬í•­_ê¸°ë³¸ì •ë³´", self.static_knowledge["notice"]))

        # í•™ì‚¬ì¼ì • ê´€ë ¨
        if any(word in question_lower for word in
               ['ìˆ˜ê°•ì‹ ì²­', 'ìˆ˜ê°•', 'ì‹ ì²­', 'ì‹œí—˜', 'ê°œê°•', 'ì¢…ê°•', 'ì¼ì •', 'ì–¸ì œ', 'í•™ì‚¬', 'ë°©í•™', 'ê³„ì ˆí•™ê¸°']):
            relevant_info.append(("í•™ì‚¬ì¼ì •_ì •ë³´", self.static_knowledge["academic_schedule"]))

        # ì‹ë‹¨ ê´€ë ¨ (ì‹¤ì‹œê°„ í¬ë¡¤ë§)
        if any(word in question_lower for word in ['ì‹ë‹¨', 'í•™ì‹', 'ë©”ë‰´', 'ì‹ë‹¹', 'ë°¥', 'ì ì‹¬', 'ì €ë…', 'ì•„ì¹¨','1í•™','2í•™','3í•™','ê¸±ì‚¬','ê¸°ìˆ™']):
            relevant_info.append(("ì‹ë‹¹_ê¸°ë³¸ì •ë³´", self.static_knowledge["dining"]))
            # ë‚ ì§œ ì¶”ì¶œ ì‹œë„
            date_str = self.extract_date_from_question(question)
            # ì‹ë‹¨ í¬ë¡¤ë§ (ë‚ ì§œ ìë™ ì²˜ë¦¬)
            today_menu = self.fetch_today_menu(date_str)
            relevant_info.append(("ì‹ë‹¨ì •ë³´", today_menu))

        # ì…”í‹€ë²„ìŠ¤ ê´€ë ¨
        if any(word in question_lower for word in ['ì…”í‹€', 'ë²„ìŠ¤', 'êµí†µ', 'ì‹œê°„í‘œ', 'ìš´í–‰', 'í†µí•™', 'ëŒ€ì „ì—­', 'ìœ ì„±']):
            relevant_info.append(("ì…”í‹€ë²„ìŠ¤_ì •ë³´", self.static_knowledge["shuttle"]))

        # ì—°ë½ì²˜ ì •ë³´ (í•­ìƒ í¬í•¨)
        relevant_info.append(("ì—°ë½ì²˜_ì •ë³´", self.static_knowledge["contacts"]))

        return relevant_info


class CompleteCampusChatBot:
    """ì™„ì „í•œ ìº í¼ìŠ¤ ì±—ë´‡ - AWQ ì–‘ìí™” ëª¨ë¸ ì‚¬ìš©"""

    def __init__(self, model_name = "Qwen/Qwen3-14B-AWQ"):
        self.model_name = model_name
        self.device = "cuda" if torch.cuda.is_available() else "cpu"

        print(f"ğŸ–¥ï¸ ë””ë°”ì´ìŠ¤: {self.device}")
        print(f"ğŸ¤– ëª¨ë¸: {model_name}")
        print("ğŸ”§ AWQ 4-bit ì–‘ìí™” ëª¨ë¸ ì‚¬ìš©")

        # ì™„ì „í•œ ì§€ì‹ ë² ì´ìŠ¤ ì´ˆê¸°í™”
        self.knowledge_base = CompleteCampusKnowledgeBase()
        print("ğŸ“š ì™„ì „í•œ ì§€ì‹ ë² ì´ìŠ¤ ë¡œë“œ ì™„ë£Œ")

        # ëª¨ë¸ ë¡œë“œ
        self.load_model()
        print("ğŸ¤– AWQ ì±—ë´‡ ì´ˆê¸°í™” ì™„ë£Œ")

    def load_model(self):
        """AWQ ì–‘ìí™” ëª¨ë¸ ë¡œë“œ"""
        try:
            print("ğŸ”„ AWQ ì–‘ìí™” Qwen ëª¨ë¸ ë¡œë”© ì¤‘...")

            # í† í¬ë‚˜ì´ì € ë¡œë“œ
            self.tokenizer = AutoTokenizer.from_pretrained(
                self.model_name,
                trust_remote_code=True
            )

            # pad_token ì„¤ì •
            if self.tokenizer.pad_token is None:
                self.tokenizer.pad_token = self.tokenizer.eos_token

            # AWQ ëª¨ë¸ ë¡œë“œ (ì´ë¯¸ ì–‘ìí™”ë˜ì–´ ìˆìŒ)
            self.model = AutoModelForCausalLM.from_pretrained(
                self.model_name,
                device_map="auto",
                torch_dtype=torch.float16,
                trust_remote_code=True,
                low_cpu_mem_usage=True
            )

            self.model.eval()
            print("âœ… AWQ ëª¨ë¸ ë¡œë”© ì™„ë£Œ (ë©”ëª¨ë¦¬ ì ˆì•½: ~70%)")

        except Exception as e:
            print(f"âŒ AWQ ëª¨ë¸ ë¡œë”© ì‹¤íŒ¨: {e}")
            print("ğŸ’¡ AWQ ëª¨ë¸ì´ ì—†ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì¼ë°˜ ëª¨ë¸ë¡œ fallback ì‹œë„...")

            # Fallback to regular model
            try:
                fallback_model = "Qwen/Qwen2.5-7B-Instruct"
                print(f"ğŸ”„ {fallback_model}ë¡œ fallback ì‹œë„...")

                self.tokenizer = AutoTokenizer.from_pretrained(fallback_model, trust_remote_code=True)
                if self.tokenizer.pad_token is None:
                    self.tokenizer.pad_token = self.tokenizer.eos_token

                self.model = AutoModelForCausalLM.from_pretrained(
                    fallback_model,
                    device_map="auto",
                    torch_dtype=torch.float16,
                    trust_remote_code=True
                )

                self.model_name = fallback_model
                print("âœ… Fallback ëª¨ë¸ ë¡œë”© ì™„ë£Œ")

            except Exception as fallback_error:
                print(f"âŒ Fallback ëª¨ë¸ë„ ì‹¤íŒ¨: {fallback_error}")
                raise

    def create_rich_context(self, relevant_info):
        """í’ë¶€í•œ ì»¨í…ìŠ¤íŠ¸ ìƒì„± (ê¸¸ì´ ìµœì í™”)"""
        context = "=== ì¶©ë‚¨ëŒ€í•™êµ ì¢…í•© ì •ë³´ ===\n\n"

        for info_type, info_data in relevant_info:
            context += f"ã€{info_type}ã€‘\n"

            if info_type == "ìµœì‹ ê³µì§€" and isinstance(info_data, list):
                for i, notice in enumerate(info_data[:2], 1):  # 3ê°œ â†’ 2ê°œë¡œ ì¶•ì†Œ
                    context += f"{i}. {notice.get('title', 'N/A')}\n"

            elif info_type == "ì˜¤ëŠ˜ë©”ë‰´":
                if info_data.get('status') == "í¬ë¡¤ë§ ì„±ê³µ":
                    context += f"ë‚ ì§œ: {info_data['date']} ({info_data['day']}ìš”ì¼)\n"
                    if 'items' in info_data and info_data['items']:
                        context += f"ë©”ë‰´: {', '.join(info_data['items'][:3])}\n"  # 5ê°œ â†’ 3ê°œë¡œ ì¶•ì†Œ
                else:
                    context += f"ìƒíƒœ: {info_data.get('message', 'ì •ë³´ ì—†ìŒ')}\n"

            elif isinstance(info_data, dict):
                # í•µì‹¬ ì •ë³´ë§Œ í¬í•¨í•˜ë„ë¡ ì¶•ì†Œ
                key_count = 0
                for key, value in info_data.items():
                    if key_count >= 3:  # ìµœëŒ€ 3ê°œ í•­ëª©ë§Œ
                        break
                    if isinstance(value, dict):
                        context += f"â€¢ {key}: {str(value)[:50]}...\n"  # ê¸¸ì´ ì œí•œ
                    else:
                        context += f"â€¢ {key}: {str(value)[:100]}\n"  # ê¸¸ì´ ì œí•œ
                    key_count += 1

            context += "\n"

            # ì „ì²´ ì»¨í…ìŠ¤íŠ¸ ê¸¸ì´ ì œí•œ
            if len(context) > 1500:  # ê¸¸ì´ ì œí•œ ê°•í™”
                context = context[:1500] + "...\n"
                break

        return context

    def create_balanced_prompt(self, question, context):
        """ë©”ëª¨ë¦¬ íš¨ìœ¨ì ì¸ í”„ë¡¬í”„íŠ¸ ìƒì„±"""
        now = datetime.now()
        today = date.today()
        weekday = today.strftime('%A')

        # ê°„ë‹¨í•œ ì‹œê°„ ì •ë³´ë§Œ
        current_context = f"í˜„ì¬: {now.strftime('%Y-%m-%d %H:%M')} ({weekday})"

        prompt = f""" /no think
                <|im_start|>system
                ë„ˆëŠ” ì¶©ë‚¨ëŒ€í•™êµ í•™ìƒì´ ê¶ê¸ˆí•œ ì •ë³´ë¥¼ ë¬¼ì–´ë³¼ë•Œ ëŒ€ë‹µí•´ì£¼ëŠ” ì–´ì‹œìŠ¤í„´íŠ¸ì•¼. 
                ë‹¤ìŒ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ê°„ê²°í•˜ê³  ì •í™•í•œ ë‹µë³€ì„ ìì‹ ê°ìˆê²Œ í•´ì¤˜.
                ë‚ ì§œì™€ ê´€ë ¨ëœ ì •ë³´ê°€ ìˆìœ¼ë©´ ì˜¤ëŠ˜ ë‚ ì§œì™€ ë¹„êµí•´ì„œ ì •ë³´ ê°€ì ¸ì™€ì¤˜
                {current_context}
                {context}
                <|im_end|>
                <|im_start|>user
                {question}
                <|im_end|>
                <|im_start|>assistant
                """
        return prompt



    def generate_comprehensive_answer(self, question, max_new_tokens=30000):
        """ë©”ëª¨ë¦¬ ìµœì í™”ëœ ë‹µë³€ ìƒì„±"""
        try:
            print(f"ğŸ” ì§ˆë¬¸ ë¶„ì„ ì¤‘: {question}")

            # ë©”ëª¨ë¦¬ ì •ë¦¬
            if torch.cuda.is_available():
                torch.cuda.empty_cache()

            # 1. ê´€ë ¨ ì •ë³´ ê²€ìƒ‰
            relevant_info = self.knowledge_base.search_comprehensive_info(question)

            # 2. ì»¨í…ìŠ¤íŠ¸ ìƒì„± (í¬ê¸° ì œí•œ)
            context = self.create_rich_context(relevant_info)

            # 3. í”„ë¡¬í”„íŠ¸ ìƒì„±
            prompt = self.create_balanced_prompt(question, context)

            # 4. í† í¬ë‚˜ì´ì§• (ê¸¸ì´ ì œí•œ ê°•í™”)
            inputs = self.tokenizer(
                prompt,
                return_tensors="pt",
                truncation=True,
                max_length=3000  # ë” ì§§ê²Œ ì œí•œ
            ).to(self.device)

            # ë©”ëª¨ë¦¬ ì •ë¦¬
            if torch.cuda.is_available():
                torch.cuda.empty_cache()

            # 5. ë‹µë³€ ìƒì„± (ë©”ëª¨ë¦¬ ì ˆì•½ ì„¤ì •)
            with torch.no_grad():
                outputs = self.model.generate(
                    **inputs,
                    max_new_tokens=max_new_tokens,  # ë” ì§§ê²Œ ì œí•œ
                    do_sample=True,
                    temperature=0.7,
                    pad_token_id=self.tokenizer.eos_token_id,
                    eos_token_id=self.tokenizer.eos_token_id
                )

            # ì¦‰ì‹œ ë©”ëª¨ë¦¬ í•´ì œ
            del inputs
            if torch.cuda.is_available():
                torch.cuda.empty_cache()

            # 6. ë””ì½”ë”©
            full_response = self.tokenizer.decode(outputs[0], skip_special_tokens=True).strip()

            # ë©”ëª¨ë¦¬ í•´ì œ
            del outputs
            if torch.cuda.is_available():
                torch.cuda.empty_cache()

            # 7. ë‹µë³€ ì¶”ì¶œ (í”„ë¡¬í”„íŠ¸ì™€ íŠ¹ìˆ˜ í† í° ì œê±°)
            answer = self.extract_answer_from_response(full_response, prompt)

            # 8. ë‹µë³€ í’ˆì§ˆ ê²€ì‚¬
            if not answer or len(answer) < 5:
                return self.get_fallback_answer(question)

            print("âœ… ë‹µë³€ ìƒì„± ì™„ë£Œ")
            return answer

        except torch.cuda.OutOfMemoryError:
            if torch.cuda.is_available():
                torch.cuda.empty_cache()
            print("âŒ GPU ë©”ëª¨ë¦¬ ë¶€ì¡± - Fallback ì‚¬ìš©")
            return self.get_fallback_answer(question)

        except Exception as e:
            if torch.cuda.is_available():
                torch.cuda.empty_cache()
            print(f"âŒ ë‹µë³€ ìƒì„± ì˜¤ë¥˜: {e}")
            return self.get_fallback_answer(question)

    def extract_answer_from_response(self, full_response, prompt):
        """ì‘ë‹µì—ì„œ ì‹¤ì œ ë‹µë³€ ë¶€ë¶„ë§Œ ì¶”ì¶œ - ê°œì„ ëœ ë²„ì „"""
        try:
            # 1. ë¨¼ì € <think> íƒœê·¸ì™€ ë‚´ìš© ì™„ì „ ì œê±°
            import re
            answer = re.sub(r'<think>.*?</think>', '', full_response, flags=re.DOTALL)

            # 2. /no think ì œê±°
            answer = re.sub(r'/no think\s*', '', answer)

            # 3. ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ ë¶€ë¶„ ì œê±°
            if "ë„ˆëŠ” ì¶©ë‚¨ëŒ€í•™êµ í•™ìƒì´ ê¶ê¸ˆí•œ ì •ë³´ë¥¼ ë¬¼ì–´ë³¼ë•Œ ëŒ€ë‹µí•´ì£¼ëŠ” ì–´ì‹œìŠ¤í„´íŠ¸ì•¼" in answer:
                # assistant ì´í›„ ë¶€ë¶„ë§Œ ì¶”ì¶œ
                parts = answer.split("assistant")
                if len(parts) > 1:
                    answer = parts[-1].strip()

            # 4. íŠ¹ìˆ˜ í† í°ë“¤ ì œê±°
            answer = re.sub(r'<\|im_end\|>', '', answer)
            answer = re.sub(r'<\|im_start\|>.*?>', '', answer)

            # 5. system, user, assistant íƒœê·¸ë“¤ ì œê±°
            answer = re.sub(r'\n\s*(system|user|assistant)\s*\n', '\n', answer)
            answer = re.sub(r'^(system|user|assistant)\s*', '', answer)

            # 6. ì»¨í…ìŠ¤íŠ¸ ì •ë³´ ì œê±°
            if "=== ì¶©ë‚¨ëŒ€í•™êµ ì¢…í•© ì •ë³´ ===" in answer:
                parts = answer.split("assistant")
                if len(parts) > 1:
                    answer = parts[-1].strip()

            # 7. í”„ë¡¬í”„íŠ¸ì—ì„œ ì‚¬ìš©ì ì§ˆë¬¸ ì¶”ì¶œí•˜ì—¬ ë‹µë³€ì—ì„œ ì œê±°
            if "user" in prompt and "assistant" in prompt:
                # ì‚¬ìš©ì ì§ˆë¬¸ ë¶€ë¶„ ì°¾ê¸°
                user_parts = prompt.split("user")
                if len(user_parts) > 1:
                    assistant_parts = user_parts[-1].split("assistant")
                    if len(assistant_parts) > 0:
                        user_question = assistant_parts[0].strip()
                        # ë‹µë³€ì—ì„œ ì‚¬ìš©ì ì§ˆë¬¸ ì œê±°
                        if user_question in answer:
                            answer = answer.replace(user_question, "").strip()

            # 8. ìµœì¢… ì •ë¦¬
            answer = answer.strip()

            # 9. ì—¬ì „íˆ ì‹œìŠ¤í…œ í…ìŠ¤íŠ¸ê°€ ë‚¨ì•„ìˆëŠ”ì§€ í™•ì¸
            unwanted_patterns = [
                r'í˜„ì¬: \d{4}-\d{2}-\d{2} \d{2}:\d{2} \([^)]+\)',
                r'ã€[^ã€‘]*ã€‘[^ã€]*',  # ã€ã€‘ë¡œ ë‘˜ëŸ¬ì‹¸ì¸ ì„¹ì…˜ë“¤
                r'â€¢ [^:]+: [^â€¢]*',  # â€¢ ë¡œ ì‹œì‘í•˜ëŠ” ì •ë³´ë“¤
            ]

            for pattern in unwanted_patterns:
                answer = re.sub(pattern, '', answer, flags=re.DOTALL)

            # 10. ë¹ˆ ì¤„ ì •ë¦¬
            answer = re.sub(r'\n\s*\n\s*\n', '\n\n', answer)
            answer = answer.strip()

            # 11. ìµœì¢… ê²€ì¦ - ë‹µë³€ì´ ë„ˆë¬´ ì§§ê±°ë‚˜ ì‹œìŠ¤í…œ ì •ë³´ë§Œ ìˆëŠ” ê²½ìš°
            if not answer or len(answer.strip()) < 10:
                return None

            # 12. ì‹œìŠ¤í…œ ì •ë³´ê°€ ì—¬ì „íˆ ë‚¨ì•„ìˆëŠ” ê²½ìš° ê°„ë‹¨í•œ ë‹µë³€ìœ¼ë¡œ ëŒ€ì²´
            if any(keyword in answer for keyword in ['ì¶©ë‚¨ëŒ€í•™êµ ì¢…í•© ì •ë³´', 'í˜„ì¬:', 'ã€', 'â€¢']):
                return None

            return answer

        except Exception as e:
            print(f"âš ï¸ ë‹µë³€ ì¶”ì¶œ ì¤‘ ì˜¤ë¥˜: {e}")
            return None

    #ë‚˜ì¤‘í™•ì¸
    def get_fallback_answer(self, question):
        """ê°„ë‹¨í•œ Fallback ë‹µë³€ (ë©”ëª¨ë¦¬ ì ˆì•½)"""
        question_lower = question.lower()

        if any(word in question_lower for word in ['ì…”í‹€', 'ë²„ìŠ¤']):
            return """ğŸšŒ 2025ë…„ ì¶©ë‚¨ëŒ€ ì…”í‹€ë²„ìŠ¤ ì•ˆë‚´

ğŸ“ êµë‚´ìˆœí™˜: 08:30~17:30 (1ì¼ 10íšŒ)
ì‹œê°„: 08:30, 09:30, 09:40, 10:30, 11:30, 13:30, 14:30, 15:30, 16:30, 17:30

ğŸ“ ë“±êµì „ìš©: ì›”í‰ì—­ 08:20 ì¶œë°œ â†’ ì •ì‹¬í™” êµ­ì œë¬¸í™”íšŒê´€
ğŸ“ ìº í¼ìŠ¤ìˆœí™˜: 08:10 ëŒ€ë• ì¶œë°œ â†’ 08:50 ë³´ìš´ ë„ì°©

ğŸ“ ë¬¸ì˜: ì´ë¬´ê³¼ 042-821-5114"""

        elif any(word in question_lower for word in ['ì¡¸ì—…', 'í•™ì ']):
            return "ì¶©ë‚¨ëŒ€í•™êµ ì¡¸ì—…ìš”ê±´ì€ 130í•™ì  ì´ìƒì…ë‹ˆë‹¤. ê³µí•™ê³„ì—´ì€ 140í•™ì ì´ í•„ìš”í•©ë‹ˆë‹¤. ìì„¸í•œ ë¬¸ì˜: í•™ì‚¬ì§€ì›ê³¼ 042-821-5025"

        elif any(word in question_lower for word in ['ì‹ë‹¨', 'ë©”ë‰´']):
            return "í•™ìƒì‹ë‹¹: í•œì‹ 4,000ì›, ì–‘ì‹ 5,000ì›. ìš´ì˜ì‹œê°„: 11:30-14:00, 17:30-19:00. ìƒí˜‘: 042-821-5890"

        else:
            return "ë¬¸ì˜ì‚¬í•­ì€ ê´€ë ¨ ë¶€ì„œë¡œ ì—°ë½ì£¼ì„¸ìš”. í•™ì‚¬ì§€ì›ê³¼ 042-821-5025, ì´ë¬´ê³¼ 042-821-5114"

    def process_test_file(self, test_file_path, output_file_path):
        """ê°œë³„ ì²˜ë¦¬ë¡œ ë©”ëª¨ë¦¬ ì ˆì•½"""
        try:
            if not os.path.exists(test_file_path):
                print(f"âŒ í…ŒìŠ¤íŠ¸ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤: {test_file_path}")
                return False

            with open(test_file_path, 'r', encoding='utf-8') as f:
                test_data = json.load(f)

            results = []
            print(f"ğŸ“ AWQ ëª¨ë¸ ê°œë³„ ì²˜ë¦¬ ì¤‘... (ì´ {len(test_data)}ê°œ)")

            for i, item in enumerate(test_data):
                try:
                    print(f"ğŸ”„ {i+1}/{len(test_data)}: {item['user'][:30]}...")

                    # ê° ì§ˆë¬¸ë§ˆë‹¤ ë©”ëª¨ë¦¬ ì •ë¦¬
                    if torch.cuda.is_available():
                        torch.cuda.empty_cache()

                    answer = self.generate_comprehensive_answer(item['user'])

                    results.append({
                        "user": item['user'],
                        "model": answer
                    })

                    # 5ê°œë§ˆë‹¤ ì¤‘ê°„ ì €ì¥ ë° ë©”ëª¨ë¦¬ ì •ë¦¬
                    if (i + 1) % 3 == 0:
                        print(f"ğŸ’¾ ì¤‘ê°„ ì €ì¥... ({i+1}ê°œ ì™„ë£Œ)")
                        self.save_partial_results(results, output_file_path)
                        if torch.cuda.is_available():
                            torch.cuda.empty_cache()

                except Exception as e:
                    print(f"âŒ ì§ˆë¬¸ {i+1} ì‹¤íŒ¨: {e}")
                    results.append({
                        "user": item['user'],
                        "model": f"ì²˜ë¦¬ ì‹¤íŒ¨: {str(e)}"
                    })
                    if torch.cuda.is_available():
                        torch.cuda.empty_cache()

            # ìµœì¢… ì €ì¥
            os.makedirs(os.path.dirname(output_file_path), exist_ok=True)
            with open(output_file_path, 'w', encoding='utf-8') as f:
                json.dump(results, f, ensure_ascii=False, indent=2)

            print(f"âœ… AWQ ëª¨ë¸ ê²°ê³¼ ì €ì¥ ì™„ë£Œ: {output_file_path}")
            return True

        except Exception as e:
            print(f"âŒ í…ŒìŠ¤íŠ¸ íŒŒì¼ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜: {e}")
            return False

    def save_partial_results(self, results, output_file_path):
        """ë¶€ë¶„ ê²°ê³¼ ì €ì¥"""
        try:
            os.makedirs(os.path.dirname(output_file_path), exist_ok=True)
            with open(output_file_path, 'w', encoding='utf-8') as f:
                json.dump(results, f, ensure_ascii=False, indent=2)
        except Exception as e:
            print(f"âš ï¸ ì¤‘ê°„ ì €ì¥ ì‹¤íŒ¨: {e}")

    def chat_interactive(self):
        """ëŒ€í™”í˜• ì±„íŒ…"""
        print("\nğŸ¤– ì¶©ë‚¨ëŒ€ AWQ ì–‘ìí™” RAG ì±—ë´‡ì…ë‹ˆë‹¤!")
        print("ğŸ“¡ ì‹¤ì‹œê°„ ì •ë³´ í¬ë¡¤ë§ì´ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤.")
        print("(ì¢…ë£Œ: 'quit' ë˜ëŠ” 'exit')")

        while True:
            try:
                user_input = input("\nğŸ‘¤ ì§ˆë¬¸: ").strip()

                if user_input.lower() in ['quit', 'exit', 'ì¢…ë£Œ']:
                    print("ğŸ‘‹ ì´ìš©í•´ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤!")
                    break

                if not user_input:
                    continue

                print("ğŸ” ì •ë³´ ê²€ìƒ‰ ë° ë‹µë³€ ìƒì„± ì¤‘...")
                answer = self.generate_comprehensive_answer(user_input)
                print(f"ğŸ¤– ë‹µë³€: {answer}")

            except KeyboardInterrupt:
                print("\nğŸ‘‹ ì´ìš©í•´ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤!")
                break


def main():
    """ë©”ì¸ í•¨ìˆ˜"""
    print("ğŸ“ ì¶©ë‚¨ëŒ€ Campus RAG ChatBot (AWQ ì–‘ìí™”)")
    print("ğŸ“¡ ì‹¤ì‹œê°„ í¬ë¡¤ë§ + ì •ì  ì •ë³´ + AWQ 4-bit ì–‘ìí™”")
    print("ğŸ”§ ë©”ëª¨ë¦¬ ìµœì í™” ë²„ì „")
    print("=" * 60)

    try:
        # AWQ ì–‘ìí™” RAG ì±—ë´‡ ì´ˆê¸°í™”
        chatbot = CompleteCampusChatBot(
            model_name = "Qwen/Qwen3-14B-AWQ"
        )

        # í…ŒìŠ¤íŠ¸ íŒŒì¼ ì²˜ë¦¬
        test_file_path = "./data/test_chat.json"
        output_file_path = "./outputs/chat_output.json"

        if os.path.exists(test_file_path):
            print(f"ğŸ“‚ í…ŒìŠ¤íŠ¸ íŒŒì¼ ë°œê²¬: {test_file_path}")
            success = chatbot.process_test_file(test_file_path, output_file_path)

            if success:
                print("âœ… AWQ ì–‘ìí™” ì±—ë´‡ í…ŒìŠ¤íŠ¸ ì™„ë£Œ!")

                # ê²°ê³¼ ë¯¸ë¦¬ë³´ê¸°
                with open(output_file_path, 'r', encoding='utf-8') as f:
                    results = json.load(f)

                print("\nğŸ“‹ ê²°ê³¼ ë¯¸ë¦¬ë³´ê¸° (ì²˜ìŒ 3ê°œ):")
                for i, result in enumerate(results[:3]):
                    print(f"\n{i + 1}. ì§ˆë¬¸: {result['user']}")
                    print(f"   ë‹µë³€: {result['model']}")
                    print("-" * 60)

                # ëª¨ë¸ ì •ë³´ ì¶œë ¥
                print(f"\nğŸ¤– ì‚¬ìš©ëœ ëª¨ë¸: {chatbot.model_name}")
                print(f"ğŸ”§ ì–‘ìí™”: AWQ 4-bit")
                print(f"ğŸ–¥ï¸ ì‹¤í–‰ ë””ë°”ì´ìŠ¤: {chatbot.device}")
                print(f"ğŸ’¾ ì˜ˆìƒ ë©”ëª¨ë¦¬ ì ˆì•½: 70%")

            else:
                print("âŒ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨!")
        else:
            print(f"âš ï¸ í…ŒìŠ¤íŠ¸ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤: {test_file_path}")

    except Exception as e:
        print(f"âŒ ì´ˆê¸°í™” ì‹¤íŒ¨: {e}")
        print("ğŸ’¡ AWQ ëª¨ë¸ì´ ì—†ê±°ë‚˜ GPU ë©”ëª¨ë¦¬ ë¶€ì¡±ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤")
        print("ğŸ’¡ fallback ëª¨ë¸ë¡œ ìë™ ì „í™˜ë©ë‹ˆë‹¤")


if __name__ == "__main__":
    main()